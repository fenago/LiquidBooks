# LiquidBooks: Three-Phase Book Creation Architecture

## Overview
LiquidBooks follows a clear three-phase workflow to create Jupyter Books:

1. **Phase 1: Generate Skeleton** - AI creates book outline/structure
2. **Phase 2: Create Content** - Generate/write chapter content
3. **Phase 3: Build & Publish** - Compile to Jupyter Book and deploy

---

## Phase 1: Generate Skeleton (Book Planning)

### Purpose
Create the complete structure and outline of the book without writing full content yet.

### User Input (Planning Form)
```
- Topic/Subject
- Book Type (Programming Tutorial, Data Science, Novel, etc.)
- Tone (Academic, Conversational, etc.)
- Target Audience (Beginner, Intermediate, Advanced)
- Number of chapters/sections
- Special requirements
- [Optional: View/Edit System Prompt]
```

### AI Process
**Endpoint**: `POST /api/ai/generate-outline`

**Input**:
```json
{
  "topic": "Machine Learning for Beginners",
  "book_type": "programming_tutorial",
  "tone": "conversational",
  "target_audience": "beginner",
  "num_chapters": 5,
  "requirements": "Include practical projects",
  "custom_system_prompt": null,  // optional override
  "custom_user_prompt": null     // optional override
}
```

**AI Output** (Skeleton):
```json
{
  "success": true,
  "outline": {
    "book": {
      "title": "Machine Learning Fundamentals: A Practical Guide",
      "description": "An interactive introduction to ML with hands-on Python examples",
      "author": "Generated by LiquidBooks",
      "target_audience": "Beginners with basic Python knowledge",
      "theme": "Modern, visual, interactive",
      "book_type": "programming_tutorial",
      "tone": "conversational"
    },
    "chapters": [
      {
        "chapter_number": 1,
        "title": "What is Machine Learning?",
        "description": "Introduction to ML concepts, types of learning, and real-world applications",
        "learning_objectives": [
          "Define machine learning and its core concepts",
          "Distinguish between supervised, unsupervised, and reinforcement learning",
          "Identify real-world ML applications"
        ],
        "suggested_components": [
          "admonitions",
          "images",
          "definition_lists",
          "cards"
        ],
        "connection_to_previous": null,
        "connection_to_next": "Provides foundation for supervised learning in Chapter 2",
        "estimated_words": 1500
      },
      {
        "chapter_number": 2,
        "title": "Your First ML Model: Linear Regression",
        "description": "Build and train a simple linear regression model",
        "learning_objectives": [
          "Understand linear regression mathematics",
          "Implement linear regression from scratch",
          "Use scikit-learn for predictions",
          "Evaluate model performance"
        ],
        "suggested_components": [
          "code_blocks",
          "math_equations",
          "interactive_plots",
          "admonitions",
          "quizzes"
        ],
        "connection_to_previous": "Applies supervised learning from Chapter 1",
        "connection_to_next": "Introduces concepts for classification in Chapter 3",
        "estimated_words": 2000
      }
      // ... more chapters
    ],
    "recommended_features": [
      "code_blocks",
      "math_equations",
      "admonitions",
      "interactive_plots",
      "quizzes",
      "tabs",
      "cards"
    ],
    "structure_explanation": "This book follows a hands-on approach. Each chapter builds on previous concepts.",
    "total_estimated_words": 8500,
    "estimated_pages": 40
  }
}
```

### User Review Screen
- Display complete outline
- Show chapter titles, descriptions, learning objectives
- Allow editing:
  - âœï¸ Edit chapter title/description
  - âž• Add new chapter
  - âŒ Remove chapter
  - ðŸ”„ Reorder chapters
  - âš™ï¸ Toggle recommended features
- **When satisfied**: Click "Next: Create Content" â†’ Go to Phase 2

### What Gets Stored
```typescript
interface BookSkeleton {
  book: {
    title: string;
    description: string;
    author: string;
    book_type: string;
    tone: string;
    target_audience: string;
    theme: string;
  };
  chapters: ChapterOutline[];
  recommended_features: string[];
  structure_explanation: string;
}

interface ChapterOutline {
  chapter_number: number;
  title: string;
  description: string;
  learning_objectives: string[];
  suggested_components: string[];
  connection_to_previous: string | null;
  connection_to_next: string | null;
  estimated_words: number;
  status: 'not_started' | 'draft' | 'in_progress' | 'complete';  // Added in Phase 2
  content: string;  // Empty initially, filled in Phase 2
}
```

---

## Phase 2: Create Content (Chapter Builder)

### Purpose
Generate or write the actual content for each chapter/section based on the skeleton.

### UI Layout
**Three-panel interface**:
- **Left**: Chapter list with status indicators
- **Center**: Content editor (Monaco) with component inserter
- **Right**: Live preview (Markdown â†’ Rendered)

### Per-Chapter Workflow

#### For Each Chapter, User Chooses:

##### Option A: Generate with AI
**User clicks "Generate with AI"**

**Endpoint**: `POST /api/ai/generate-chapter`

**Input**:
```json
{
  "book_context": {
    "title": "ML Fundamentals",
    "book_type": "programming_tutorial",
    "tone": "conversational",
    "target_audience": "beginner"
  },
  "chapter": {
    "number": 2,
    "title": "Your First ML Model",
    "description": "Build and train a simple linear regression model",
    "learning_objectives": ["...", "...", "..."],
    "suggested_components": ["code_blocks", "math_equations", "quizzes"],
    "connection_to_previous": "Applies supervised learning from Chapter 1",
    "connection_to_next": "Introduces concepts for classification"
  },
  "additional_instructions": "Use Boston housing dataset as example",
  "custom_system_prompt": null,  // optional
  "custom_user_prompt": null     // optional
}
```

**AI Output**:
```json
{
  "success": true,
  "content": "# Your First ML Model: Linear Regression\n\nIn this chapter...\n\n```{admonition} Learning Objectives\n:class: note\n- Understand linear regression\n- Implement with scikit-learn\n- Evaluate performance\n```\n\n## Introduction\n\nLinear regression is one of the simplest...\n\n```python\nimport numpy as np\nfrom sklearn.linear_model import LinearRegression\n\n# Your first model\nmodel = LinearRegression()\n```\n\n... [full chapter content in MyST Markdown]\n",
  "estimated_tokens": 2341,
  "components_used": ["code_blocks", "admonitions", "math_equations", "quiz"]
}
```

**Chapter status changes to**: `draft`

##### Option B: Write Manually
- User types in Monaco editor
- Insert Jupyter components via UI dialogs
- Live preview updates
- Save draft automatically

**Chapter status**: `in_progress`

##### Option C: AI + Edit (Most Common)
1. Generate with AI first
2. Edit the generated content
3. Insert/modify components as needed

**Chapter status**: `in_progress` â†’ `complete`

### Component Insertion System

Each Jupyter Book feature has an insert dialog that generates correct MyST syntax:

**Example: Insert Code Block**
```typescript
// User clicks "Insert Code Block"
// Dialog collects:
{
  language: "python",
  tags: ["hide-input"],
  name: "my-code-cell",
  code: "print('Hello')"
}

// Generates MyST:
{code-cell} python
:tags: [hide-input]
:name: my-code-cell

print('Hello')
```

**Available Components**:
- Text formatting (headings, lists, blockquotes)
- Code blocks (with tags)
- Math equations (inline/display)
- Admonitions (note, warning, tip, etc.)
- Figures/Images
- Tables
- Tabs
- Cards
- Grids
- Dropdowns
- Quizzes
- Interactive plots
- Theorems/Proofs
- Citations
- Cross-references

### Progress Tracking
```typescript
interface ChapterStatus {
  not_started: number;  // Empty, no content
  draft: number;        // AI generated, not edited
  in_progress: number;  // Being edited
  complete: number;     // Finalized
}

// Show progress: "3 of 5 chapters complete (60%)"
```

### When All Chapters Complete
User clicks **"Next: Build & Publish"** â†’ Go to Phase 3

### What Gets Stored
```typescript
interface BookWithContent {
  skeleton: BookSkeleton;  // From Phase 1
  chapters: Chapter[];     // Now with content
}

interface Chapter {
  ...ChapterOutline,  // All fields from skeleton
  content: string,    // Full MyST Markdown content
  status: 'complete',
  word_count: number,
  last_edited: string,
  ai_generated: boolean
}
```

---

## Phase 3: Build & Publish (Compilation & Deployment)

### Purpose
Take the complete book (skeleton + content) and compile it into a Jupyter Book, then optionally deploy it.

### User Input (Publishing Form)
```
Preview Mode:
- [Preview] View what the book will look like

Build Settings:
- â˜‘ Execute code cells
- â˜‘ Generate table of contents
- â˜‘ Include search functionality
- â˜ Enable Thebe (live code)
- â˜ Add Binder launch button
- â˜ Add Colab launch button

Export Options:
- â˜‘ HTML (interactive website)
- â˜ PDF (via LaTeX)
- â˜ Export source files (.zip)

Deployment:
- ( ) Local only (download)
- (â€¢) Deploy to GitHub Pages
  - GitHub username: [...]
  - Repo name: [...]
  - Access token: [...]
- ( ) Deploy to Netlify
- ( ) Custom server (FTP)
```

### Backend Process

**Endpoint**: `POST /api/build`

**Input**:
```json
{
  "book": {
    "id": "book-12345",
    "title": "ML Fundamentals",
    "author": "Your Name",
    "description": "...",
    "chapters": [
      {
        "id": "chapter-1",
        "title": "What is Machine Learning?",
        "content": "# What is Machine Learning?\n\n...",
        "order": 0
      },
      {
        "id": "chapter-2",
        "title": "Your First ML Model",
        "content": "# Your First ML Model\n\n...",
        "order": 1
      }
      // ... all chapters with full content
    ],
    "features": ["code_blocks", "math_equations", "quizzes", "interactive_plots"]
  },
  "build_options": {
    "execute_notebooks": true,
    "enable_thebe": false,
    "enable_binder": false,
    "enable_colab": false,
    "generate_pdf": false
  },
  "deployment": {
    "type": "github_pages",  // or 'local', 'netlify', 'custom'
    "github_username": "user",
    "github_token": "...",
    "repo_name": "my-ml-book"
  }
}
```

### Backend Steps

#### 1. Create Temporary Directory
```python
temp_dir = Path(tempfile.mkdtemp(prefix="liquidbook_"))
```

#### 2. Generate `_config.yml`
```python
def generate_enhanced_config(book: Book, features: List[str]) -> str:
    """Generate complete _config.yml with all extensions"""

    config = f"""
title: "{book.title}"
author: "{book.author}"
logo: ""

# Execution settings
execute:
  execute_notebooks: {'auto' if build_options.execute_notebooks else 'off'}
  timeout: 180
  allow_errors: false

# MyST extensions
parse:
  myst_enable_extensions:
    - amsmath
    - colon_fence
    - deflist
    - dollarmath
    - html_admonition
    - linkify
    - replacements
    - smartquotes
    - substitution
    - tasklist

# Sphinx extensions (dynamic based on features)
sphinx:
  extra_extensions:
"""

    # Add extensions based on enabled features
    if 'code_blocks' in features:
        config += "    - sphinx_copybutton\n"
    if 'cards' in features or 'tabs' in features or 'grids' in features:
        config += "    - sphinx_design\n"
    if 'theorems' in features or 'proofs' in features:
        config += "    - sphinx_proof\n"
    if 'quizzes' in features:
        config += "    - jupyterquiz\n"

    # Add theme and launch button config
    if build_options.enable_thebe or build_options.enable_binder:
        config += """
launch_buttons:
  binderhub_url: https://mybinder.org
  notebook_interface: jupyterlab
  thebe: true
"""

    return config
```

#### 3. Generate `_toc.yml`
```python
def generate_toc(book: Book) -> str:
    """Generate table of contents"""

    sorted_chapters = sorted(book.chapters, key=lambda x: x.order)

    toc = "format: jb-book\n"
    toc += f"root: {sanitize_filename(sorted_chapters[0].title)}\n"
    toc += "chapters:\n"

    for chapter in sorted_chapters[1:]:
        filename = sanitize_filename(chapter.title)
        toc += f"  - file: {filename}\n"

    return toc
```

#### 4. Write Chapter Files
```python
def write_chapters(book: Book, book_dir: Path):
    """Write all chapter markdown files"""

    sorted_chapters = sorted(book.chapters, key=lambda x: x.order)

    for i, chapter in enumerate(sorted_chapters):
        if i == 0:
            # First chapter is root/intro
            filepath = book_dir / "intro.md"
        else:
            filename = sanitize_filename(chapter.title)
            filepath = book_dir / f"{filename}.md"

        # Write full chapter content
        filepath.write_text(chapter.content)
```

#### 5. Create References File
```python
# Create empty references.bib
(book_dir / "references.bib").write_text("")
```

#### 6. Build Jupyter Book
```python
def build_jupyter_book(book_dir: Path) -> dict:
    """Run jupyter-book build command"""

    result = subprocess.run(
        ["jupyter-book", "build", str(book_dir), "--all"],
        capture_output=True,
        text=True,
        timeout=300
    )

    return {
        "success": result.returncode == 0,
        "stdout": result.stdout,
        "stderr": result.stderr
    }
```

#### 7. Deploy (Optional)
```python
if deployment.type == 'github_pages':
    deploy_to_github(
        book_dir,
        deployment.github_username,
        deployment.github_token,
        deployment.repo_name
    )
elif deployment.type == 'netlify':
    deploy_to_netlify(book_dir, deployment.netlify_token)
```

### Output
```json
{
  "success": true,
  "message": "Book built successfully!",
  "url": "https://username.github.io/my-ml-book",
  "build_dir": "/tmp/liquidbook_abc123",
  "build_log": "Building book...\nFinished successfully",
  "pages": 42,
  "word_count": 8734,
  "build_time_seconds": 23.5
}
```

### User Sees
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ“ Book Published Successfully!         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Your book is live at:                  â”‚
â”‚  ðŸ”— https://user.github.io/ml-book     â”‚
â”‚                                         â”‚
â”‚  Statistics:                            â”‚
â”‚  â€¢ 5 chapters                           â”‚
â”‚  â€¢ 42 pages                             â”‚
â”‚  â€¢ 8,734 words                          â”‚
â”‚  â€¢ Built in 23.5s                       â”‚
â”‚                                         â”‚
â”‚  [View Book] [Download Source]          â”‚
â”‚  [Share Link] [Edit Book]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Complete Data Flow

### Phase 1 â†’ Phase 2
```
Planning Form â†’ AI generates skeleton â†’ User reviews/edits
â†“
Store BookSkeleton in state/localStorage
â†“
Navigate to Phase 2 with skeleton
```

### Phase 2 â†’ Phase 3
```
For each chapter:
  Generate with AI OR Write manually â†’ Edit content â†’ Mark complete
â†“
Store BookWithContent (skeleton + all chapter content)
â†“
Navigate to Phase 3 with complete book
```

### Phase 3 â†’ Published Book
```
BookWithContent â†’ Backend builds Jupyter Book â†’ Deploy
â†“
User gets live URL + download options
```

---

## API Endpoints Summary

### Phase 1: Skeleton
- `POST /api/ai/generate-outline` - Generate book skeleton
- `POST /api/ai/preview-outline-prompt` - Preview prompt before generating

### Phase 2: Content
- `POST /api/ai/generate-chapter` - Generate single chapter content
- `POST /api/ai/preview-chapter-prompt` - Preview chapter prompt
- `POST /api/ai/assist-writing` - AI Assistant for editing (continue/rewrite/etc.)

### Phase 3: Build
- `POST /api/build` - Build and deploy Jupyter Book
- `GET /api/build/status/{build_id}` - Check build progress (for async builds)
- `POST /api/preview` - Generate preview without deploying

---

## State Management

```typescript
// Global state (Zustand)
interface LiquidBooksState {
  // Phase 1
  skeleton: BookSkeleton | null;

  // Phase 2
  chapters: Chapter[];
  currentChapter: number;

  // Phase 3
  buildStatus: 'idle' | 'building' | 'success' | 'error';
  buildResult: BuildResult | null;

  // Actions
  setSkeleton: (skeleton: BookSkeleton) => void;
  updateChapter: (index: number, content: string) => void;
  setChapterStatus: (index: number, status: ChapterStatus) => void;
  setBuildResult: (result: BuildResult) => void;
}
```

---

## User Journey

1. **Start**: User clicks "Create New Book" from Dashboard
2. **Phase 1**: Fill form â†’ Generate skeleton â†’ Review â†’ Next
3. **Phase 2**: For each chapter: Generate/Write â†’ Edit â†’ Complete â†’ Next
4. **Phase 3**: Configure build â†’ Build â†’ Deploy â†’ View live book
5. **Done**: Share link or download files

Total time: 15-30 minutes for AI-generated 5-chapter book
